============================= test session starts ==============================
platform darwin -- Python 3.11.12, pytest-8.4.1, pluggy-1.6.0 -- /Users/emanuelesabetta/Code/MFR/.venv/bin/python3
cachedir: .pytest_cache
rootdir: /Users/emanuelesabetta/Code/MFR
configfile: pyproject.toml
plugins: anyio-4.9.0, cov-6.2.1
collecting ... collected 16 items

tests/test_mass_find_replace.py::test_dry_run_behavior PASSED            [  6%]
tests/test_mass_find_replace.py::test_dry_run_virtual_paths PASSED       [ 12%]
tests/test_mass_find_replace.py::test_path_resolution_after_rename PASSED [ 18%]
tests/test_mass_find_replace.py::test_folder_nesting PASSED              [ 25%]
tests/test_mass_find_replace.py::test_unicode_combining_chars PASSED     [ 31%]
tests/test_mass_find_replace.py::test_permission_error_handling PASSED   [ 37%]
tests/test_mass_find_replace.py::test_self_test_option FAILED            [ 43%]
tests/test_mass_find_replace.py::test_symlink_name_processing PASSED     [ 50%]
tests/test_mass_find_replace.py::test_extension_filtering PASSED         [ 56%]
tests/test_mass_find_replace.py::test_rtf_processing PASSED              [ 62%]
tests/test_mass_find_replace.py::test_binary_files_logging FAILED        [ 68%]
tests/test_mass_find_replace.py::test_recursive_path_resolution PASSED   [ 75%]
tests/test_mass_find_replace.py::test_gb18030_encoding FAILED            [ 81%]
tests/test_mass_find_replace.py::test_collision_error_logging PASSED     [ 87%]
tests/test_mass_find_replace.py::test_interactive_mode_collision_skip PASSED [ 93%]
tests/test_mass_find_replace.py::test_malformed_json_handling PASSED     [100%]

=================================== FAILURES ===================================
____________________________ test_self_test_option _____________________________
tests/test_mass_find_replace.py:311: in test_self_test_option
    with patch("mass_find_replace.mass_find_replace._run_subprocess_command") as mock_run:
../../.local/share/uv/python/cpython-3.11.12-macos-aarch64-none/lib/python3.11/unittest/mock.py:1446: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
../../.local/share/uv/python/cpython-3.11.12-macos-aarch64-none/lib/python3.11/unittest/mock.py:1419: in get_original
    raise AttributeError(
E   AttributeError: <module 'mass_find_replace.mass_find_replace' from '/Users/emanuelesabetta/Code/MFR/src/mass_find_replace/mass_find_replace.py'> does not have the attribute '_run_subprocess_command'
__________________________ test_binary_files_logging ___________________________
tests/test_mass_find_replace.py:383: in test_binary_files_logging
    assert log_path.exists()
E   AssertionError: assert False
E    +  where False = exists()
E    +    where exists = PosixPath('/private/var/folders/j5/4vmcr_496wsbmt3dl3k8f11r0000gn/T/pytest-of-emanuelesabetta/pytest-207/test_binary_files_logging0/runtime/binary_files_matches.log').exists
----------------------------- Captured stderr call -----------------------------
16:28:02.791 | INFO    | Flow run 'swinging-magpie' - Beginning flow run 'swinging-magpie' for flow 'Mass Find Replace'
16:28:02.791 | INFO    | Flow run 'swinging-magpie' - Scanning '/private/var/folders/j5/4vmcr_496wsbmt3dl3k8f11r0000gn/T/pytest-of-emanuelesabetta/pytest-207/test_binary_files_logging0/runtime'...
16:28:02.793 | INFO    | Flow run 'swinging-magpie' - Scan complete. 5 transactions planned in '/private/var/folders/j5/4vmcr_496wsbmt3dl3k8f11r0000gn/T/pytest-of-emanuelesabetta/pytest-207/test_binary_files_logging0/runtime/planned_transactions.json'
16:28:02.794 | INFO    | Flow run 'swinging-magpie' - Execution phase complete. Stats: {'total': 5, 'completed': 5, 'skipped': 0, 'failed': 0, 'retry_later': 0}
16:28:02.799 | INFO    | Flow run 'swinging-magpie' - Finished in state Completed()
------------------------------ Captured log call -------------------------------
INFO     prefect.flow_runs:flow_engine.py:651 Beginning flow run 'swinging-magpie' for flow 'Mass Find Replace'
INFO     prefect.flow_runs:scanner.py:74 Scanning '/private/var/folders/j5/4vmcr_496wsbmt3dl3k8f11r0000gn/T/pytest-of-emanuelesabetta/pytest-207/test_binary_files_logging0/runtime'...
INFO     prefect.flow_runs:scanner.py:142 Scan complete. 5 transactions planned in '/private/var/folders/j5/4vmcr_496wsbmt3dl3k8f11r0000gn/T/pytest-of-emanuelesabetta/pytest-207/test_binary_files_logging0/runtime/planned_transactions.json'
INFO     prefect.flow_runs:transaction_orchestrator.py:144 Execution phase complete. Stats: {'total': 5, 'completed': 5, 'skipped': 0, 'failed': 0, 'retry_later': 0}
INFO     prefect.flow_runs:flow_engine.py:724 Finished in state Completed()
____________________________ test_gb18030_encoding _____________________________
tests/test_mass_find_replace.py:496: in test_gb18030_encoding
    assert encoding_in_tx == "gb18030", f"Wrong encoding: {tx.get('ORIGINAL_ENCODING')}"
E   AssertionError: Wrong encoding: None
E   assert '' == 'gb18030'
E
E     - gb18030
----------------------------- Captured stderr call -----------------------------
16:28:03.002 | INFO    | Flow run 'fabulous-wildcat' - Beginning flow run 'fabulous-wildcat' for flow 'Mass Find Replace'
16:28:03.003 | INFO    | Flow run 'fabulous-wildcat' - Scanning '/private/var/folders/j5/4vmcr_496wsbmt3dl3k8f11r0000gn/T/pytest-of-emanuelesabetta/pytest-207/test_gb18030_encoding0/runtime'...
16:28:03.377 | INFO    | Flow run 'fabulous-wildcat' - Scan complete. 4735 transactions planned in '/private/var/folders/j5/4vmcr_496wsbmt3dl3k8f11r0000gn/T/pytest-of-emanuelesabetta/pytest-207/test_gb18030_encoding0/runtime/planned_transactions.json'
16:28:03.517 | INFO    | Flow run 'fabulous-wildcat' - Execution phase complete. Stats: {'total': 4735, 'completed': 4735, 'skipped': 0, 'failed': 0, 'retry_later': 0}
16:28:03.524 | INFO    | Flow run 'fabulous-wildcat' - Finished in state Completed()
------------------------------ Captured log call -------------------------------
INFO     prefect.flow_runs:flow_engine.py:651 Beginning flow run 'fabulous-wildcat' for flow 'Mass Find Replace'
INFO     prefect.flow_runs:scanner.py:74 Scanning '/private/var/folders/j5/4vmcr_496wsbmt3dl3k8f11r0000gn/T/pytest-of-emanuelesabetta/pytest-207/test_gb18030_encoding0/runtime'...
INFO     prefect.flow_runs:scanner.py:142 Scan complete. 4735 transactions planned in '/private/var/folders/j5/4vmcr_496wsbmt3dl3k8f11r0000gn/T/pytest-of-emanuelesabetta/pytest-207/test_gb18030_encoding0/runtime/planned_transactions.json'
INFO     prefect.flow_runs:transaction_orchestrator.py:144 Execution phase complete. Stats: {'total': 4735, 'completed': 4735, 'skipped': 0, 'failed': 0, 'retry_later': 0}
INFO     prefect.flow_runs:flow_engine.py:724 Finished in state Completed()
=========================== short test summary info ============================
FAILED tests/test_mass_find_replace.py::test_self_test_option - AttributeErro...
FAILED tests/test_mass_find_replace.py::test_binary_files_logging - Assertion...
FAILED tests/test_mass_find_replace.py::test_gb18030_encoding - AssertionErro...
========================= 3 failed, 13 passed in 6.70s =========================
--- Logging error ---
Traceback (most recent call last):
  File "/Users/emanuelesabetta/Code/MFR/.venv/lib/python3.11/site-packages/prefect/logging/handlers.py", line 337, in emit
    self.console.print(message, soft_wrap=True)
  File "/Users/emanuelesabetta/Code/MFR/.venv/lib/python3.11/site-packages/rich/console.py", line 1692, in print
    with self:
  File "/Users/emanuelesabetta/Code/MFR/.venv/lib/python3.11/site-packages/rich/console.py", line 866, in __exit__
    self._exit_buffer()
  File "/Users/emanuelesabetta/Code/MFR/.venv/lib/python3.11/site-packages/rich/console.py", line 824, in _exit_buffer
    self._check_buffer()
  File "/Users/emanuelesabetta/Code/MFR/.venv/lib/python3.11/site-packages/rich/console.py", line 2033, in _check_buffer
    self._write_buffer()
  File "/Users/emanuelesabetta/Code/MFR/.venv/lib/python3.11/site-packages/rich/console.py", line 2102, in _write_buffer
    self.file.write(text)
ValueError: I/O operation on closed file.
Call stack:
  File "/Users/emanuelesabetta/Code/MFR/.venv/lib/python3.11/site-packages/prefect/server/api/server.py", line 917, in stop
    subprocess_server_logger.info(
  File "/Users/emanuelesabetta/.local/share/uv/python/cpython-3.11.12-macos-aarch64-none/lib/python3.11/logging/__init__.py", line 1497, in info
    self._log(INFO, msg, args, **kwargs)
  File "/Users/emanuelesabetta/.local/share/uv/python/cpython-3.11.12-macos-aarch64-none/lib/python3.11/logging/__init__.py", line 1642, in _log
    self.handle(record)
  File "/Users/emanuelesabetta/.local/share/uv/python/cpython-3.11.12-macos-aarch64-none/lib/python3.11/logging/__init__.py", line 1652, in handle
    self.callHandlers(record)
  File "/Users/emanuelesabetta/.local/share/uv/python/cpython-3.11.12-macos-aarch64-none/lib/python3.11/logging/__init__.py", line 1714, in callHandlers
    hdlr.handle(record)
  File "/Users/emanuelesabetta/.local/share/uv/python/cpython-3.11.12-macos-aarch64-none/lib/python3.11/logging/__init__.py", line 986, in handle
    self.emit(record)
  File "/Users/emanuelesabetta/Code/MFR/.venv/lib/python3.11/site-packages/prefect/logging/handlers.py", line 343, in emit
    self.handleError(record)
Message: 'Stopping temporary server on http://127.0.0.1:8926'
Arguments: ()
